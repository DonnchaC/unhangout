# Loadtest reunhangout

This directory contains a load testing rig for the reunhangout plenary app,
simulating chat traffic, joining and leaving.

## Installation

Requires python 3.4 or higher.

Install requirements:
```
pip install -r requirements.txt
```

## Operation

The load test script will use the HTTP interface to register a number of
loadtest users, and then create raw websockets that connect directly to the
Django server and sending traffic.

If a single client machine is unable to generate sufficient traffic to saturate
the server, you can split the test across multiple machines, specifying a range
of usernames for each.

## Usage

Basic usage is `./loadtest.py <url> <plenary-slug>`, e.g.:

```
./loadtest.py http://localhost:8000 test
```

This will register 10 users with the names `loadtest0`, `loadtest1`, etc., and
start sending traffic to `http://localhost:8000/event/test/`. That plenary must
already exist and be "open".

### More users and multiple plenaries

Add additional users by specifying the range of usernames to generate.  This will generate 100 users, numbered 0 to 100:

```
./loadtest.py http://localhost:8000 test --user-range-min 0 --user-range-max 100
```

By splitting ranges, traffic can be generated by multiple client machines:

```
# machine 1
./loadtest.py http://localhost:8000 test --user-range-min 0 --user-range-max 100
# machine 2
./loadtest.py http://localhost:8000 test --user-range-min 100 --user-range-max 200
# machine 3
./loadtest.py http://localhost:8000 test --user-range-min 200 --user-range-max 300
```

Similarly, multiple simultaneous invocations of `./loadtest.py` could specify
different plenary slugs, and thus simulate multiple simultaneous plenaries.

For complete usage, see `./loadtest.py --help`.

## Automating with AWS

Included in this directory is an ansible configuration for spinning up ec2
instances to run load testing.  To use this, first overwrite `vars/secrets.yml` with an ansible vault or variable file containing the following:

 - `vault_ec2_key_name`: The name of an SSH key pair to use
 - `vault_aws_access_key`: The AWS access key
 - `vault_aws_secret_key`: The AWS secret key
 - `vault_ec2_security_group_id`: Security group ID for ec2 instances. `"sg-ac3f77d4"`, which allows SSH/HTTP(S) from anywhere, is recommended
 - `vault_loadtest_url`: The URL of the server to place under load.
 - `vault_loadtest_user_password`: The password to use for loadtest user accounts.

Next, run the ansible playbook `./loadtest.yml`.  The included Makefile shows
examples for invoking the playbook with different user ranges. To spin up
multiple user ranges simultaneously, or to test multiple simultaneous events,
run the playbook multiple times in separate terminals.
